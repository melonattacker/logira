rules:
  - id: "F001"
    title: "Write under ~/.ssh"
    type: "file"
    severity: "high"
    when:
      file:
        prefix: "$HOME/.ssh/"
        op_in: ["create", "modify"]
    message: "write under ~/.ssh: {{file.op}} {{file.path}}"

  - id: "F200"
    title: "Executable created under /tmp"
    type: "file"
    severity: "medium"
    when:
      file:
        prefix: "/tmp/"
        op_in: ["create", "modify"]
        require_exec_bit: true
    message: "executable file under /tmp: {{file.op}} {{file.path}}"

  - id: "N001"
    title: "Outbound connect to high port"
    type: "net"
    severity: "low"
    when:
      net:
        op: "connect"
        dst_port_gte: 1024
    message: "outbound connect to high port {{net.dst_ip}}:{{net.dst_port}}"

  - id: "E001"
    title: "Possible curl|sh execution pattern"
    type: "exec"
    severity: "high"
    when:
      exec:
        contains_all: ["curl", "|", "sh"]
    message: "possible curl|sh execution pattern: {{exec.filename}}"

  # A) Credential / Sensitive Access
  - id: "F010"
    title: "Write under ~/.aws"
    type: "file"
    severity: "high"
    when:
      file:
        prefix: "$HOME/.aws/"
        op_in: ["create", "modify"]
    message: "write under ~/.aws: {{file.op}} {{file.path}}"

  - id: "F011"
    title: "Write under gcloud config"
    type: "file"
    severity: "medium"
    when:
      file:
        prefix: "$HOME/.config/gcloud/"
        op_in: ["create", "modify"]
    message: "write under gcloud config: {{file.op}} {{file.path}}"

  - id: "F012"
    title: "Write under kube config"
    type: "file"
    severity: "high"
    when:
      file:
        prefix: "$HOME/.kube/"
        op_in: ["create", "modify"]
    message: "write under kube config: {{file.op}} {{file.path}}"

  - id: "F013"
    title: "Write under docker config"
    type: "file"
    severity: "medium"
    when:
      file:
        prefix: "$HOME/.docker/"
        op_in: ["create", "modify"]
    message: "write under docker config: {{file.op}} {{file.path}}"

  - id: "F014"
    title: "Write credentials file"
    type: "file"
    severity: "high"
    when:
      file:
        path_in:
          - "$HOME/.git-credentials"
          - "$HOME/.netrc"
        op_in: ["create", "modify"]
    message: "write credentials file: {{file.op}} {{file.path}}"

  - id: "F015"
    title: "Write package registry credentials"
    type: "file"
    severity: "medium"
    when:
      file:
        path_in:
          - "$HOME/.npmrc"
          - "$HOME/.pypirc"
        op_in: ["create", "modify"]
    message: "write package registry credentials: {{file.op}} {{file.path}}"

  # B) Persistence / System Modification
  - id: "F100"
    title: "Write under /etc"
    type: "file"
    severity: "medium"
    when:
      file:
        prefix: "/etc/"
        op_in: ["create", "modify"]
    message: "write under /etc: {{file.op}} {{file.path}}"

  - id: "F110"
    title: "Write systemd unit"
    type: "file"
    severity: "high"
    when:
      file:
        prefix_any:
          - "/etc/systemd/system/"
          - "/lib/systemd/system/"
          - "/usr/lib/systemd/system/"
        op_in: ["create", "modify"]
    message: "write systemd unit: {{file.op}} {{file.path}}"

  - id: "F120"
    title: "Write cron config"
    type: "file"
    severity: "high"
    when:
      file:
        prefix_any:
          - "/etc/cron.d/"
          - "/etc/cron.daily/"
          - "/etc/cron.hourly/"
          - "/etc/cron.weekly/"
          - "/etc/cron.monthly/"
        op_in: ["create", "modify"]
    message: "write cron config: {{file.op}} {{file.path}}"

  - id: "F121"
    title: "Write user crontab spool"
    type: "file"
    severity: "high"
    when:
      file:
        prefix: "/var/spool/cron/"
        op_in: ["create", "modify"]
    message: "write user crontab spool: {{file.op}} {{file.path}}"

  - id: "F130"
    title: "Write user systemd unit"
    type: "file"
    severity: "high"
    when:
      file:
        prefix: "$HOME/.config/systemd/user/"
        op_in: ["create", "modify"]
    message: "write user systemd unit: {{file.op}} {{file.path}}"

  - id: "F131"
    title: "Write desktop autostart entry"
    type: "file"
    severity: "high"
    when:
      file:
        prefix: "$HOME/.config/autostart/"
        op_in: ["create", "modify"]
    message: "write desktop autostart entry: {{file.op}} {{file.path}}"

  - id: "F132"
    title: "Write shell startup file"
    type: "file"
    severity: "medium"
    when:
      file:
        path_in:
          - "$HOME/.bashrc"
          - "$HOME/.bash_profile"
          - "$HOME/.profile"
          - "$HOME/.zshrc"
          - "$HOME/.config/fish/config.fish"
        op_in: ["create", "modify"]
    message: "write shell startup file: {{file.op}} {{file.path}}"

  # E) Temp/Dropper
  - id: "F201"
    title: "Executable created under /dev/shm"
    type: "file"
    severity: "medium"
    when:
      file:
        prefix: "/dev/shm/"
        op_in: ["create", "modify"]
        require_exec_bit: true
    message: "executable file under /dev/shm: {{file.op}} {{file.path}}"

  - id: "F202"
    title: "Executable created under /var/tmp"
    type: "file"
    severity: "medium"
    when:
      file:
        prefix: "/var/tmp/"
        op_in: ["create", "modify"]
        require_exec_bit: true
    message: "executable file under /var/tmp: {{file.op}} {{file.path}}"

  # C) Suspicious Execution Patterns
  - id: "E010"
    title: "Possible wget|sh execution pattern"
    type: "exec"
    severity: "high"
    when:
      exec:
        contains_all: ["wget", "|", "sh"]
    message: "possible wget|sh execution pattern: {{exec.filename}}"

  - id: "E011"
    title: "SSH reverse tunnel flag"
    type: "exec"
    severity: "medium"
    when:
      exec:
        contains_all: ["ssh", "-R"]
    message: "ssh reverse tunnel flag used: {{exec.filename}}"

  - id: "E012"
    title: "SSH dynamic proxy flag"
    type: "exec"
    severity: "medium"
    when:
      exec:
        contains_all: ["ssh", "-D"]
    message: "ssh dynamic proxy flag used: {{exec.filename}}"

  - id: "E013"
    title: "chmod +x used"
    type: "exec"
    severity: "medium"
    when:
      exec:
        contains_all: ["chmod", "+x"]
    message: "chmod +x used: {{exec.filename}}"

  - id: "E014"
    title: "Potential tunnel or reverse shell tool"
    type: "exec"
    severity: "medium"
    when:
      exec:
        contains_any: ["socat", "ncat", "nc "]
    message: "potential tunnel or reverse shell tool executed: {{exec.filename}}"

  - id: "E015"
    title: "Base64 decode with shell hint"
    type: "exec"
    severity: "medium"
    when:
      exec:
        contains_all: ["base64", "-d"]
        contains_any: ["sh", "bash"]
    message: "base64 decode with shell hint: {{exec.filename}}"

  # D) Network Egress / Exfil
  - id: "N010"
    title: "Outbound connect to suspicious port"
    type: "net"
    severity: "medium"
    when:
      net:
        op: "connect"
        dst_port_in: [4444, 1337, 6666, 9001, 31337]
    message: "outbound connect to suspicious port {{net.dst_ip}}:{{net.dst_port}}"

  - id: "N020"
    title: "Cloud metadata endpoint access"
    type: "net"
    severity: "high"
    when:
      net:
        op: "connect"
        dst_ip_in: ["169.254.169.254"]
    message: "cloud metadata endpoint access {{net.dst_ip}}:{{net.dst_port}}"
